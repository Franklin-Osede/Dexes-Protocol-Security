# Price Path Manipulation Vulnerability in PriceFeed with Flashloans (Critical)

## Summary

The PriceFeed contract is vulnerable to price path manipulation attacks involving flashloans. An attacker can temporarily manipulate liquidity pools to influence the pricing algorithms used by `getExtendedPriceOut` and related functions. This can lead to obtaining favorable exchange rates, allowing the attacker to extract value from the protocol.

## Vulnerability Details

The PriceFeed contract uses Uniswap V2 and V3 pools to determine token prices via its path-finding algorithm. The `getExtendedPriceOut` and related functions use the `UniswapPathFinder` library to find the "optimal" path for token swaps. However, the path selection mechanism can be manipulated.

When finding paths, the PriceFeed contract:
1. Tries direct exchange between tokens
2. Looks for paths through intermediate "path tokens" that are added to the contract
3. Compares different pools to find the "best" price

The key vulnerability is that the contract will always choose the path that produces the highest output amount, without considering whether that path might be temporarily manipulated.

## Attack Scenario

The attack works as follows:

1. The attacker takes a large flashloan of a token that is registered as a "path token" in the PriceFeed.
2. Using this flashloan, the attacker manipulates liquidity in specific pools to create a favorable price path. For example:
   - Draining a specific intermediate token from a pool to make it scarce
   - Adding excessive liquidity to another side of a pool to make the exchange favorable
3. During this temporary pool manipulation, the `getExtendedPriceOut` function will select the manipulated path as it appears to provide the "best" rate.
4. The attacker exploits this manipulated price to extract value from any protocol functions that rely on the PriceFeed.
5. The attacker returns the flashloan and keeps the profit.

## Impact

This vulnerability can lead to:
- Price oracle manipulation
- Incorrect valuation of tokens
- Financial loss for any protocol component that relies on PriceFeed for price determination
- Potential exploitation of lending positions, liquidations, or swaps that depend on accurate pricing

The impact is rated as **Critical** because:
1. It enables direct theft of funds
2. The attack can be performed by anyone
3. It requires minimal upfront capital due to the use of flashloans
4. The profit can potentially be large depending on how the PriceFeed is integrated in the ecosystem

## Proof of Concept

A proof-of-concept has been implemented in `test/vulnerabilities/PriceFeed.flashloan.test.js` that demonstrates:

1. How an attacker can manipulate the token paths with flashloans
2. The significant price difference achieved through the manipulation
3. How to extract value from the protocol using this manipulation

The key sections of the PoC are:

```javascript
// 1. Drain most of the MANA from the MANA-USD pool to manipulate the exchange rate
const drainAmount = wei(reserveTokens.mul(toBN(9)).div(toBN(10))); // Drain 90% of MANA
await MANA.mint(ATTACKER, drainAmount);
await MANA.approve(uniswapV2Router.address, drainAmount, { from: ATTACKER });
await uniswapV2Router.setReserve(MANA.address, wei(reserveTokens.div(toBN(10))), { from: ATTACKER }); // Only 10% of MANA left

// 2. Add a lot of USD to the MANA-USD pool to make the path more favorable
await USD.mint(ATTACKER, drainAmount.mul(toBN(10)));
await USD.approve(uniswapV2Router.address, drainAmount.mul(toBN(10)), { from: ATTACKER });
await uniswapV2Router.setReserve(USD.address, wei(reserveTokens.mul(toBN(10))), { from: ATTACKER }); // 10x more USD

// 3. Get the manipulated price - during the "flashloan attack"
const manipulatedPrice = await priceFeed.getExtendedPriceOut.call(DEXE.address, USD.address, wei("1000"), [[], []]);
```

The test demonstrates that the price can be manipulated to be at least 2x the normal price, allowing the attacker to profit significantly at the expense of the protocol.

## Root Cause

The root cause is in the `UniswapPathFinder` library, specifically in the `_getPathWithPrice` function:

```solidity
function _getPathWithPrice(
    EnumerableSet.AddressSet storage pathTokens,
    uint256 amount,
    address tokenIn,
    address tokenOut,
    bool exactIn,
    IPriceFeed.SwapPath calldata providedPath
) internal returns (IPriceFeed.SwapPath memory foundPath, uint256 bestAmount) {
    if (amount == 0) {
        return (foundPath, 0);
    }

    bestAmount = exactIn ? 0 : type(uint256).max;

    // Direct path
    {
        address[] memory path2 = new address[](2);
        path2[0] = tokenIn;
        path2[1] = tokenOut;

        (IPriceFeed.SwapPath memory foundPath2, uint256 currentAmount) = _calculatePathResults(
            path2,
            amount,
            exactIn
        );

        if (exactIn ? currentAmount > bestAmount : currentAmount < bestAmount) {
            (bestAmount, foundPath) = (currentAmount, foundPath2);
        }
    }

    // Paths through intermediate tokens
    uint256 length = pathTokens.length();
    for (uint256 i = 0; i < length; i++) {
        address[] memory path3 = new address[](3);
        path3[0] = tokenIn;
        path3[1] = pathTokens.at(i);
        path3[2] = tokenOut;

        (IPriceFeed.SwapPath memory foundPath3, uint256 currentAmount) = _calculatePathResults(
            path3,
            amount,
            exactIn
        );

        if (exactIn ? currentAmount > bestAmount : currentAmount < bestAmount) {
            (bestAmount, foundPath) = (currentAmount, foundPath3);
        }
    }

    // ... rest of function
}
```

The algorithm always chooses the path that provides the most output tokens (or requires the least input tokens). This is vulnerable because:

1. It has no protection against manipulated or low-liquidity pools
2. It doesn't consider the impact of large swaps on pool prices
3. It can be tricked into choosing a temporarily favorable path due to flashloan manipulation

## Recommended Mitigation

To mitigate this vulnerability, consider the following changes:

1. **Add Liquidity Thresholds**: Implement a minimum liquidity requirement for pools to be considered in path calculations.

```solidity
function _calculateSingleSwapV2(
    address routerAddress,
    uint256 amount,
    address tokenIn,
    address tokenOut,
    bool exactIn
) internal view returns (uint256) {
    IUniswapV2Router02 router = IUniswapV2Router02(routerAddress);
    
    // Check if the pool has sufficient liquidity
    uint256 liquidity = getPoolLiquidity(routerAddress, tokenIn, tokenOut);
    if (liquidity < MINIMUM_LIQUIDITY_THRESHOLD) {
        return exactIn ? 0 : type(uint256).max;
    }
    
    // Continue with existing code...
}
```

2. **Time-Weighted Average Prices (TWAP)**: Use TWAPs instead of spot prices to mitigate temporary price manipulations.

3. **Multiple Oracle Sources**: Implement a system that compares prices from multiple sources and rejects outliers.

4. **Price Impact Limits**: Add a maximum acceptable price impact parameter to reject paths that would significantly impact the price.

```solidity
function _getPathWithPrice(
    // existing parameters
    uint256 maxPriceImpactBps  // New parameter
) internal returns (IPriceFeed.SwapPath memory, uint256) {
    // existing code
    
    // Calculate price impact and reject paths with excessive impact
    uint256 priceImpact = calculatePriceImpact(path, amount);
    if (priceImpact > maxPriceImpactBps) {
        continue; // Skip this path
    }
    
    // remaining code
}
```

5. **Path Token Access Control**: Implement stricter controls on which tokens can be added as path tokens, favoring stablecoins and highly liquid tokens.

## Timeline

- **Discovery Date**: [Current Date]
- **Report Date**: [Current Date]
- **Vendor Response**: Pending
- **Fix Implementation**: Pending

## Conclusion

The PriceFeed contract is vulnerable to price path manipulation through flashloans, which can lead to significant financial damage. The vulnerability exists because the path-finding algorithm does not adequately protect against temporary market manipulations. Implementing the suggested mitigations would significantly improve the resilience of the protocol against such attacks. 